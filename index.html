<!DOCTYPE html>
<html>
  <head>
    <title>RGB Channels</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width", initial-scale="1">
  </head>
  <body>
    <div id="main-view">
      <!--If the canvas has any pixel/s that are from an untrusted source it will be tainted and you will not be able to read the pixel data. 
          Trusted sources are same domain or images served with the appropriate CORS header information. 
          Images that are on the file system can not have their pixels accessed. Once a canvas is tainted it can not be cleaned.-->
      <input type="file" id="input">
    </div>
    <script>
      const computeAndLogAverageOf = function(displayName, arr) {
          let sum = arr.reduce((a, b) => a + b),
              avg = sum / arr.length

          console.log(`${displayName} average value: ${avg}`)
      }

      const computeAvgUsingCanvas = function() {
          const convertURIToImageData = function(URI) {
              return new Promise(function(resolve, reject) {
                  if (URI === null) return reject()

                  let canvas = document.createElement('canvas'),
                      context = canvas.getContext('2d'),
                      image = new Image()

                  image.addEventListener('load', function() {
                      canvas.width = image.width
                      canvas.height = image.height

                      context.drawImage(image, 0, 0, canvas.width, canvas.height)

                      resolve(context.getImageData(0, 0, canvas.width, canvas.height))
                  }, false)

                  image.src = URI
              })
          }

          let self = this,
              file = self.files[0],
              reader = new FileReader()

          reader.onload = () => {
              convertURIToImageData(reader.result)
                .then((imageData) => {
                    let pix = imageData.data,
                        reds = [],
                        greens = [],
                        blues = []

                    for (let i = 0, pl = pix.length; i < pl; i += 4) {
                        reds.push(pix[i]) // store all the red
                        greens.push(pix[i + 1]) // store all the green
                        blues.push(pix[i + 2]) // store all the blue
                        // pix[i + 3] alpha (the fourth element)
                    }

                    console.log('Using canvas to scan RGB channels')
                    computeAndLogAverageOf('red', reds)
                    computeAndLogAverageOf('green', greens)
                    computeAndLogAverageOf('blue', blues)
                })
          }

          reader.readAsDataURL(file)
      }

      const computeAvgUsingFileReader = function() {
          let self = this,
              file = self.files[0],
              reader = new FileReader()

          reader.onload = () => {
              let buffer = new Uint8ClampedArray(reader.result),
                  reds = [],
                  greens = [],
                  blues = []

              for (let i = 0, bl = buffer.length; i < bl; i += 4) {
                  reds.push(buffer[i]) // store all the red
                  greens.push(buffer[i + 1]) // store all the green
                  blues.push(buffer[i + 2]) // store all the blue
                  // pix[i + 3] alpha (the fourth element)
              }

              console.log('Using ArrayBuffer to Uint8ClampedArray to scan RGB channels')
              computeAndLogAverageOf('red', reds)
              computeAndLogAverageOf('green', greens)
              computeAndLogAverageOf('blue', blues)
          }

          reader.readAsArrayBuffer(file)
      }

      document.getElementById('input')
          .addEventListener('change', computeAvgUsingCanvas, false)
      document.getElementById('input')
          .addEventListener('change', computeAvgUsingFileReader, false)
    </script>
  </body>
</html>
